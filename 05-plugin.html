<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Plugins - Mig by example</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="00-foreword.html">Foreword</a></li><li class="chapter-item expanded "><a href="01-hello-world.html"><strong aria-hidden="true">1.</strong> Hello world example</a></li><li class="chapter-item expanded "><a href="02-request-anatomy.html"><strong aria-hidden="true">2.</strong> Anatomy of the request</a></li><li class="chapter-item expanded "><a href="03-response-anatomy.html"><strong aria-hidden="true">3.</strong> Anatomy of the response</a></li><li class="chapter-item expanded "><a href="04-other-monads.html"><strong aria-hidden="true">4.</strong> Using other monads</a></li><li class="chapter-item expanded "><a href="05-plugin.html" class="active"><strong aria-hidden="true">5.</strong> Plugins</a></li><li class="chapter-item expanded "><a href="06-swagger.html"><strong aria-hidden="true">6.</strong> Using Swagger</a></li><li class="chapter-item expanded "><a href="06-json-api-example.html"><strong aria-hidden="true">7.</strong> JSON application: weather forecast</a></li><li class="chapter-item expanded "><a href="07-blog-post-example.html"><strong aria-hidden="true">8.</strong> HTML example: blog site</a></li><li class="chapter-item expanded "><a href="08-reference.html"><strong aria-hidden="true">9.</strong> Reference</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Mig by example</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="plugins"><a class="header" href="#plugins">Plugins</a></h1>
<p>A plugin is a transformation which is applied to all routes in the server.
It is a pair of functions which transform API-description and server function:</p>
<pre><code class="language-haskell">data Plugin m = Plugin
  { info :: RouteInfo -&gt; RouteInfo
  -- ^ update api schema
  , run :: PluginFun m
  -- ^ update server function
  }

-- | Low-level plugin function.
type PluginFun m = ServerFun m -&gt; ServerFun m
</code></pre>
<p>To apply plugin to server we ca use function <code>applyPlugin</code>:</p>
<pre><code class="language-haskell">-- | Applies plugin to all routes of the server.
applyPlugin :: forall f. (ToPlugin f) =&gt; 
  f -&gt; Server (MonadOf f) -&gt; Server (MonadOf f)
</code></pre>
<p>There is also infix operatore for application <code>($:)</code>.</p>
<p>The class <code>ToPlugin</code> contains all types that can be converted to plugin.
Here we use the same trick as with <code>ToServer</code> class to be able to read type-safe parts of the request
and update the API-schema. The type-level function <code>MonadOf</code> knows how to find underlying monad <code>m</code>
in various types.</p>
<p>We have recursive set of rules for types that can be converted to <code>Plugin</code>:</p>
<p>The identity rule:</p>
<blockquote>
<p><code>PluginFun</code> has instance of <code>ToPlugin</code> with obvious identity instance</p>
</blockquote>
<p>Recursive steps for inputs</p>
<blockquote>
<p>if <code>f</code> is <code>ToPlugin</code> then <code>(Query name queryType -&gt; f)</code> is <code>ToPlugin</code> too</p>
</blockquote>
<p>and so on for other types of request input (query params, headers, captures, request bodies).
See the full list of instances in the module <code>Mig.Core.Class.Plugin</code>.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>So the plugin allows us to apply some behavior to all routes in the server.
Let's discuss some examples</p>
<h3 id="add-logging"><a class="header" href="#add-logging">Add logging</a></h3>
<p>Let's add the logging to all methods which are called. We will log which route 
was called and we will include the time stamp and the full path in the log:</p>
<p>Let's imagine that we have a function</p>
<pre><code class="language-haskell">logInfo :: Text -&gt; IO ()
</code></pre>
<p>We can query the path with <code>PathInfo</code> newtype:</p>
<pre><code class="language-haskell">newtype PathInfo = PathInfo [Text]
</code></pre>
<p>And we have a rule for  <code>ToPlugin</code> class:</p>
<blockquote>
<p>if <code>f</code> is <code>ToPlugin</code> then <code>(PathInfo -&gt; ToPlugin f)</code> is <code>ToPlugin</code></p>
</blockquote>
<p>so we can create a plugin function:</p>
<pre><code class="language-haskell">logRoutes :: Plugin IO
logRoutes = toPlugin $ \(PathInfo pathItems) -&gt; prependServerAction $ do
  now &lt;- getCurrentTime 
  logInfo $ mconcat
    [ &quot;Call route: &quot;, Text.intercalata &quot;/&quot; pathItems 
    , &quot; at &quot;, Text.pack (show now)
    ]
</code></pre>
<p>We use function <code>prependServerAction</code> that creates a <code>Plugin</code>
from actino which is performed prior to call to server function:</p>
<pre><code class="language-haskell">prependServerAction :: MonadIO m =&gt; m () -&gt; Plugin m
</code></pre>
<p>also there are similar functions in the module: <code>appendServerAction</code> and <code>processResponse</code>.</p>
<h3 id="allow-only-secure-routes"><a class="header" href="#allow-only-secure-routes">Allow only secure routes</a></h3>
<p>Another great example of plugin at work is to block routes on some conditions.
For example if we want certain routes to be used only under secure SSL connection.
We have a standard function for that <code>whenSecure</code>. But let's dive into it's definition to
see how plugins can be used:</p>
<pre><code class="language-haskell">-- | Execute request only if it is secure (made with SSL connection)
whenSecure :: forall m. (MonadIO m) =&gt; Plugin m
whenSecure = toPlugin $ \(IsSecure isSecure) -&gt; 
  processResponse (if isSecure then id else const (pure Nothing))
</code></pre>
<p>Here we use standard plugin <code>processResponse</code> which allows
us to alter the result of the HTTP-response:</p>
<pre><code class="language-haskell">processResponse :: MonadIO m =&gt; 
  (m (Maybe Response) -&gt; m (Maybe Response)) -&gt; Plugin m
</code></pre>
<p>Also we use query input <code>IsSecure</code> which is true if connection is made over SSL:</p>
<pre><code class="language-haskell">newtype IsSecure = IsSecure Bool
</code></pre>
<p>So we pass through the response with identity if connection is secure
and we block the execution by returning <code>Nothing</code> if connection is secure.
The cool part of it is that due to Haskell's laziness there is no performance overhead and underlying
route is not going to be performed if connection is insecure.</p>
<h3 id="authorization-with-plugin"><a class="header" href="#authorization-with-plugin">Authorization with plugin</a></h3>
<p>Let's use this schema for authorization to site. 
There is a route that provides authorized users with session tokens.
User can pass credentials as request body over secure connection
and get session token in response which is valid for some time. </p>
<p>With that token user can access the rest of the application.
User can pass token as special header. And we check in the application
that token is valid.</p>
<p>Imagine that we have a type for a session token:</p>
<pre><code class="language-haskell">newtype AuthToken = AuthToken Text
    deriving newtype 
      (ToJSON, FromJSON, FromHttpApiData, Eq, Ord, Show, ToParamSchema, ToSchema)
</code></pre>
<p>And we can get it from some route:</p>
<pre><code class="language-haskell">getToken :: Body UserCreds -&gt; Post (Resp AuthToken)
</code></pre>
<p>We would like to block invalid sessions for all routes of our site.
We can create it in similiar way as <code>whenSecure</code>:</p>
<pre><code class="language-haskell">isValid :: AuthToken -&gt; IO Bool
isValid = ...

headerAuth :: Header &quot;auth&quot; AuthToken -&gt; Plugin IO
headerAuth (Header token) = processResponse $ \getResp -&gt; do
  isOk &lt;- isValid token
  if isOk
    then getResp
    else pure $ Just $ bad badRequest400 &quot;Auth token is invalid&quot;

whenAuth :: Server IO -&gt; Server IO
whenAuth = applyPlugin headerAuth
</code></pre>
<p>In this example we use <code>IsResp</code> instance for low-level http <code>Response</code>
to report authorization error. The header with name <code>&quot;auth&quot;</code> is required
for all routes which are part of the server to which we apply the plugin.</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>In this chapter we have learned on plugins. They provide a tool to apply
transformation to all routes in the server. Which can be useful for logging, authrization
and adding common behavior to all routes.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="04-other-monads.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="06-swagger.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="04-other-monads.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="06-swagger.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
