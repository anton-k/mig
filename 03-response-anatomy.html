<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Anatomy of the response - Mig by example</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="00-foreword.html">Foreword</a></li><li class="chapter-item expanded "><a href="01-hello-world.html"><strong aria-hidden="true">1.</strong> Hello world example</a></li><li class="chapter-item expanded "><a href="02-request-anatomy.html"><strong aria-hidden="true">2.</strong> Anatomy of the request</a></li><li class="chapter-item expanded "><a href="03-response-anatomy.html" class="active"><strong aria-hidden="true">3.</strong> Anatomy of the response</a></li><li class="chapter-item expanded "><a href="04-other-monads.html"><strong aria-hidden="true">4.</strong> Using other monads</a></li><li class="chapter-item expanded "><a href="05-middleware.html"><strong aria-hidden="true">5.</strong> Middlewares</a></li><li class="chapter-item expanded "><a href="06-swagger.html"><strong aria-hidden="true">6.</strong> Using Swagger</a></li><li class="chapter-item expanded "><a href="06-json-api-example.html"><strong aria-hidden="true">7.</strong> JSON application: weather forecast</a></li><li class="chapter-item expanded "><a href="07-blog-post-example.html"><strong aria-hidden="true">8.</strong> HTML example: blog site</a></li><li class="chapter-item expanded "><a href="08-reference.html"><strong aria-hidden="true">9.</strong> Reference</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Mig by example</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="anatomy-of-the-response"><a class="header" href="#anatomy-of-the-response">Anatomy of the response</a></h1>
<p>For the next example we are going to study which outputs can
handler produce. Let's study the HTTP-response.</p>
<h2 id="http-response"><a class="header" href="#http-response">Http response</a></h2>
<p>We already have seen the <code>Resp</code> data type in the first chapter:</p>
<pre><code class="language-haskell">-- | Response with info on the media-type encoded as type.
data Resp media a = Resp
  { status :: Status
  -- ^ response status
  , headers :: ResponseHeaders
  -- ^ response headers
  , body :: Maybe a
  -- ^ response body. Nothing means &quot;no content&quot; in the body
  }
  deriving (Show, Functor)
</code></pre>
<p>It is the main type to return values and additional HTTP-information
from response.</p>
<p>An HTTP-response contains:</p>
<ul>
<li>integer status. It's 200 when everything is allright</li>
<li>list of headers which provide useful info on response type</li>
<li>the byte string body which contains result of handler operation. It can
hold JSOn, HTML, plain text, raw byte string and other types of outputs.</li>
</ul>
<p>In the <code>Resp</code> type the <code>media</code> type argument specifies which
type the body has. By this type handler knows how to convert value
to low-level byte string representation.</p>
<h3 id="when-things-go-bad"><a class="header" href="#when-things-go-bad">When things go bad</a></h3>
<p>Sometimes things go bad and we would like to send errors and
state in the status the type of the error. To report errors
we have special type <code>RespOr</code>:</p>
<pre><code class="language-haskell">-- | Response that can contain an error. The error is represented 
-- with left case of an Either-type.

newtype RespOr ty err a = RespOr {unRespOr :: Either (Resp ty err) (Resp ty a)}
</code></pre>
<p>So this value has two possible responses which share the same media type.
We need two different responses to be able to report errors with different 
type than the type of the result.</p>
<h3 id="response-type-class-isresp"><a class="header" href="#response-type-class-isresp">Response type class <code>IsResp</code></a></h3>
<p>To unify the output we have special type class called <code>IsResp</code> for
all types which can be converted to low-level HTTP-response type <code>Response</code>.</p>
<p>Let's study this type class.
It has two associated types for the type of the body (<code>RespBody</code>) and type of the error (<code>RespError</code>):</p>
<pre><code class="language-haskell">class IsResp a where
  type RespBody a :: Type
  type RespError a :: Type
</code></pre>
<p>We can return successful result with method <code>ok</code>:</p>
<pre><code class="language-haskell">  -- | Returns valid repsonse with 200 status
  ok :: RespBody a -&gt; a
</code></pre>
<p>When things go bad we can report error with method <code>bad</code>:</p>
<pre><code class="language-haskell">  -- | Returns an error with given status
  bad :: Status -&gt; RespError a -&gt; a
</code></pre>
<p>Sometimes at rare cases we do not wnat to return any content from response.
we can just report error status and leave the body empty:</p>
<pre><code class="language-haskell">  -- | response with no content
  noContent :: Status -&gt; a
</code></pre>
<p>We can add custom headers to the response by method <code>addHeaders</code>:</p>
<pre><code class="language-haskell">  -- | Add some header to the response
  addHeaders :: ResponseHeaders -&gt; a -&gt; a
</code></pre>
<p>Note that header <code>Content-Type</code> is set automatically. Although sometimes
we would like set it explicitly. For that we have the method:</p>
<pre><code class="language-haskell">  -- | Set the media type of the response
  setMedia :: MediaType -&gt; a -&gt; a
</code></pre>
<p>also the core of the class is the method to convert value to low-level response:</p>
<pre><code class="language-haskell">  -- | Converts value to low-level response
  toResponse :: a -&gt; Response
</code></pre>
<p>Both <code>Resp</code> and <code>RespOr</code> are instances of <code>IsResp</code> class and 
we can <code>Send</code> as HTTP-response anything which has instance of <code>IsResp</code>.
For now there are only three types. The third one is the low-level <code>Response</code>.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>So we use <code>Resp</code> if we are sure that handler always produce a value
and we use <code>RespOr</code> if handler can produce and error.</p>
<h3 id="how-to-return-error"><a class="header" href="#how-to-return-error">How to return error</a></h3>
<p>We already have seen many usages of <code>Resp</code> type. Let's define something
that can produce an error. Let's define server that calculates
square root of the value. For negative numbers it is not defined in the 
realm of real numbers. So let's define the handler that use RespOr type:</p>
<pre><code class="language-haskell">import Mig.Json.IO

server :: Server IO
server = 
  &quot;square-root&quot; /. squareRoot

squareRoot :: Body Float -&gt; Post (RespOr Text Float)
squareRoot (Body arg) = Send $ pure $
  if arg &gt;= 0 
    then ok (sqrt arg)
    else bad badRequest400 &quot;Argument for square root should be non-negative&quot;
</code></pre>
<p>So we return error message and bad request status 400 when 
negative argument is passed to the handler.</p>
<p>Also note this function looks like pure GET-type function but by the HTTP rules
we can not have body request in the GET-method. So we use POST instead.</p>
<p>Also we have special case function for bad requests called <code>badReq</code>. The
values for status come from the library http-types. See the module dediicated
to <a href="https://hackage.haskell.org/package/http-types-0.12.3/docs/Network-HTTP-Types-Status.html#t:Status">HTTP-statuses</a>.
It is reexported by the <code>mig</code> library.</p>
<h3 id="how-to-set-headers"><a class="header" href="#how-to-set-headers">How to set headers</a></h3>
<p>For example in the Header we expect trace id with which we can 
find the request and response in the logs. And we want to pass the
trace id from request to the response. Let's do it with <code>addHeaders</code>:</p>
<pre><code class="language-haskell">passTrace :: Header &quot;trace-id&quot; Text -&gt; Post (Resp ())
passTrace (Header traceId) = Send $ 
  pure $ addHeaders [(&quot;trace-id&quot;, toHeader traceId)] $ ok ()
</code></pre>
<p>The function <code>toHeader</code> is re-exported from the library <a href="https://hackage.haskell.org/package/http-api-data-0.5/docs/Web-HttpApiData.html"><code>http-api-data</code></a>.
It converts various values to header byte string.</p>
<p>also there is a function if we want to add only one header and not a list of them:</p>
<pre><code class="language-haskell">setHeader :: (IsResp a, ToHttpApiData h) =&gt; HeaderName -&gt; h -&gt; a -&gt; a
</code></pre>
<p>It has <code>toHeader</code> built into it.</p>
<p>Just like we set headrs we also can set HTTP-status of the response.
we just apply it to Resp-like value. It works both for <code>Resp</code> and <code>RespOr</code>:</p>
<pre><code class="language-haskell">setStatus :: IsResp a =&gt; Status -&gt; a -&gt; a
</code></pre>
<p>Although we rarely need this function as <code>ok</code> sets the right status 
for successful response and all functions that need the status take it as argument.</p>
<h3 id="how-it-works-with-server-definition"><a class="header" href="#how-it-works-with-server-definition">How it works with server definition</a></h3>
<p>How we can use both of the types as responses: <code>Resp</code> and <code>RespOr</code>.
Recall that <code>/.</code> function is overloaded by the second argument and
we have a rule for <code>ToServer</code> class thar:</p>
<blockquote>
<p>if <code>a</code> has <code>IsResp</code> instance then <code>Send method m a</code> is convertible to server</p>
</blockquote>
<p>As for both <code>Resp</code> and <code>RespOr</code> the inctance for <code>IsResp</code> is defined we can use
both types as a result of the HTTP-handler.</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>We have learned that there are only tow types to return from server handler:</p>
<ul>
<li><code>Resp</code> for handlers that always produce a value</li>
<li><code>RespOr</code> for handlers that can fail</li>
</ul>
<p>The need for the second type is to have different type of the error 
and different for the result. If both error and result have the same 
type then we can use <code>Resp</code>. This is common case for HTML servers when we
return HTML-page as result. In case of error we would like to show the page too
as in case of success. The difference would be in the HTTP-status of the response.</p>
<p>And this goes well with <code>IsResp</code> class as for <code>Resp media a</code> error type <code>RespError</code>
equals to <code>a</code> as the value for <code>RespBody</code> too.</p>
<p>Also we have learned various methods of the <code>IsResp</code> class and how they 
can be useful in server definitions.</p>
<p>With this chapter we have covered both requests and responses and which types the can 
have. See the source code <a href="https://github.com/anton-k/mig/blob/main/examples/mig-example-apps/RouteArgs/Main.hs"><code>RouteArgs</code></a>
for examples on the topic that we have just studied.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="02-request-anatomy.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="04-other-monads.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="02-request-anatomy.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="04-other-monads.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
